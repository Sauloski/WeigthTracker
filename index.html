<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Peso</title>
    <!-- Tailwind CSS desde CDN para no necesitar un archivo local -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para los íconos de + y eliminar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 800px;
        }
        /* Ocultar el scrollbar en el historial para una apariencia más limpia */
        .history-list {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .history-list::-webkit-scrollbar {
            display: none;
        }
        /* Estilo para la ventana modal */
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .chart-container {
            position: relative;
            height: 300px; /* Altura fija para el gráfico */
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div class="container bg-white p-6 sm:p-10 rounded-3xl shadow-xl border border-gray-100">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-gray-800">Seguimiento de Peso ⚖️</h1>
        <p class="text-center text-gray-500 mb-8">Registra tu progreso y mantente motivado.</p>
        
        <!-- Sección para establecer la meta de peso -->
        <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Establecer Meta</h2>
            <div class="flex items-center space-x-4">
                <input type="number" id="goalInput" placeholder="Peso meta (kg)" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
                <button id="setGoalBtn" class="bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-200">Establecer</button>
            </div>
            <div id="goalDisplay" class="mt-4 text-lg font-medium text-center text-gray-700"></div>
        </div>
        
        <!-- Sección de barra de progreso y datos principales -->
        <div id="progressSection" class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-8 hidden">
            <div class="flex justify-between items-center mb-2">
                <span id="currentWeightDisplay" class="text-2xl font-bold text-blue-600"></span>
                <span id="goalWeightDisplay" class="text-xl text-gray-600"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                <div id="progressBar" class="h-4 rounded-full transition-all duration-500 ease-in-out" style="background-color: rgb(22, 41, 92); width: 0%;"></div>
            </div>
            <div class="text-center text-sm text-gray-500">
                <span id="progressMessage"></span>
            </div>
        </div>

        <!-- Sección del gráfico de progreso -->
        <div id="chartSection" class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Historial de Peso</h2>
            <div class="chart-container">
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <!-- Sección del historial de registros -->
        <div id="historySection" class="bg-gray-50 p-6 rounded-2xl border border-gray-200 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Últimos Registros</h2>
            <ul id="historyList" class="max-h-60 overflow-y-auto history-list">
                <!-- Los registros se insertarán aquí por JavaScript -->
            </ul>
        </div>
    </div>

    <!-- Barra inferior con botón flotante para añadir peso -->
    <div class="fixed bottom-0 left-0 w-full flex justify-center p-4 bg-white shadow-lg rounded-t-3xl">
        <button id="showModalBtn" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center text-2xl">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Ventana Modal para registrar peso, oculta por defecto -->
    <div id="weightModal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Registrar Peso</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-xl transition-colors duration-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="weightInput" class="block text-sm font-medium text-gray-700">Peso actual (kg):</label>
                    <input type="number" id="weightInput" placeholder="Ej. 75.5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
                </div>
                <div>
                    <label for="dateInput" class="block text-sm font-medium text-gray-700">Fecha:</label>
                    <input type="date" id="dateInput" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
                </div>
            </div>
            <button id="saveBtn" class="mt-6 w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-200">Guardar Peso</button>
        </div>
    </div>

    <!-- Mensajes del Sistema (Éxito/Error) -->
    <div id="messageBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 text-sm text-center text-white bg-green-500 rounded-lg shadow-lg hidden transition-opacity duration-300"></div>
    
    <!-- Chart.js para el gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Declaración de constantes y variables globales
        const weightInput = document.getElementById('weightInput');
        const dateInput = document.getElementById('dateInput');
        const goalInput = document.getElementById('goalInput');
        const saveBtn = document.getElementById('saveBtn');
        const setGoalBtn = document.getElementById('setGoalBtn');
        const showModalBtn = document.getElementById('showModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const weightModal = document.getElementById('weightModal');
        const goalDisplay = document.getElementById('goalDisplay');
        const progressBar = document.getElementById('progressBar');
        const currentWeightDisplay = document.getElementById('currentWeightDisplay');
        const goalWeightDisplay = document.getElementById('goalWeightDisplay');
        const progressMessage = document.getElementById('progressMessage');
        const historyList = document.getElementById('historyList');
        const progressSection = document.getElementById('progressSection');
        const chartSection = document.getElementById('chartSection');
        const historySection = document.getElementById('historySection');
        const messageBox = document.getElementById('messageBox');

        let weightData = {};
        let goalWeight = null;
        let startWeight = null;
        let myChart;

        const mainColor = 'rgb(22, 41, 92)'; // Color azul solicitado

        // Funciones de utilidad
        
        /**
         * Muestra un mensaje temporal en la pantalla.
         * @param {string} message - El mensaje a mostrar.
         * @param {string} type - 'success' o 'error' para definir el color del fondo.
         */
        const showMessage = (message, type) => {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            messageBox.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500', 'opacity-100');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        };

        /**
         * Guarda los datos en el localStorage del navegador.
         */
        const saveData = () => {
            localStorage.setItem('weightData', JSON.stringify(weightData));
            if (goalWeight) {
                localStorage.setItem('goalWeight', goalWeight);
            }
            if (startWeight) {
                localStorage.setItem('startWeight', startWeight);
            }
        };

        /**
         * Carga los datos desde el localStorage del navegador.
         */
        const loadData = () => {
            const storedData = localStorage.getItem('weightData');
            if (storedData) {
                weightData = JSON.parse(storedData);
            }
            const storedGoal = localStorage.getItem('goalWeight');
            if (storedGoal) {
                goalWeight = parseFloat(storedGoal);
                goalInput.value = goalWeight;
            }
            const storedStart = localStorage.getItem('startWeight');
            if (storedStart) {
                startWeight = parseFloat(storedStart);
            }

            // Establece la fecha de hoy por defecto en el input de la modal
            dateInput.value = new Date().toISOString().slice(0, 10);
        };

        // Lógica principal de la aplicación
        
        /**
         * Calcula el promedio de un array de números.
         * @param {number[]} arr - El array de números.
         * @returns {number} - El promedio.
         */
        const calculateAverage = (arr) => arr.reduce((acc, val) => acc + val, 0) / arr.length;

        /**
         * Renderiza el gráfico de peso.
         */
        const renderChart = () => {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const sortedDates = Object.keys(weightData).sort();
            const labels = sortedDates;
            const data = sortedDates.map(date => {
                // Si hay múltiples registros para un día, se usa el promedio
                const dailyWeights = weightData[date];
                return calculateAverage(dailyWeights);
            });

            // Destruye el gráfico anterior si existe para evitar errores
            if (myChart) {
                myChart.destroy();
            }

            // Crea un gradiente para un estilo más moderno en el gráfico
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(22, 41, 92, 0.4)');
            gradient.addColorStop(1, 'rgba(22, 41, 92, 0)');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Peso Promedio',
                        data: data,
                        borderColor: mainColor,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4, // Curva suave
                        pointBackgroundColor: mainColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: mainColor,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false } // Ocultar líneas de cuadrícula
                        },
                        y: {
                            display: true,
                            grid: { color: '#e5e7eb' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: mainColor,
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += `${context.parsed.y.toFixed(2)} kg`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };

        /**
         * Renderiza la barra de progreso.
         */
        const renderProgress = () => {
            if (!goalWeight || Object.keys(weightData).length === 0) {
                progressSection.classList.add('hidden');
                return;
            }
            progressSection.classList.remove('hidden');

            const latestDate = Object.keys(weightData).sort().pop();
            const latestWeights = weightData[latestDate];
            const currentWeight = calculateAverage(latestWeights);

            currentWeightDisplay.textContent = `${currentWeight.toFixed(2)} kg`;
            goalWeightDisplay.textContent = `Meta: ${goalWeight.toFixed(2)} kg`;

            let progressPercentage;
            let message;

            if (startWeight > goalWeight) { // Caso de pérdida de peso
                const totalChange = startWeight - goalWeight;
                const currentChange = startWeight - currentWeight;
                progressPercentage = (currentChange / totalChange) * 100;
                message = `Vas ${currentChange.toFixed(2)} kg abajo. Te faltan ${Math.abs(currentWeight - goalWeight).toFixed(2)} kg.`;
            } else { // Caso de ganancia de peso
                const totalChange = goalWeight - startWeight;
                const currentChange = currentWeight - startWeight;
                progressPercentage = (currentChange / totalChange) * 100;
                message = `Has ganado ${currentChange.toFixed(2)} kg. Te faltan ${Math.abs(goalWeight - currentWeight).toFixed(2)} kg.`;
            }

            if (progressPercentage >= 100) {
                progressPercentage = 100;
                message = `¡Felicitaciones! Has alcanzado tu meta de ${goalWeight.toFixed(2)} kg.`;
            } else if (progressPercentage < 0) {
                 progressPercentage = 0;
                 message = "Tu progreso no se está acercando a tu meta. ¡Sigue adelante!";
            }
            
            progressBar.style.width = `${Math.min(100, Math.max(0, progressPercentage))}%`;
            progressMessage.textContent = message;
        };

        /**
         * Elimina un registro de peso.
         * @param {string} dateToDelete - La fecha del registro a eliminar.
         */
        const deleteWeightEntry = (dateToDelete) => {
            delete weightData[dateToDelete];
            saveData();
            renderUI();
            showMessage('Registro eliminado correctamente.', 'success');
        };

        /**
         * Renderiza la lista de registros recientes.
         */
        const renderHistory = () => {
            const sortedDates = Object.keys(weightData).sort((a, b) => new Date(b) - new Date(a));
            
            if (sortedDates.length === 0) {
                historySection.classList.add('hidden');
                return;
            }
            historySection.classList.remove('hidden');
            
            historyList.innerHTML = '';
            
            // Mostrar los últimos 10 registros
            sortedDates.slice(0, 10).forEach(date => {
                const dailyWeights = weightData[date];
                const averageWeight = calculateAverage(dailyWeights);
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-lg border-b border-gray-100 last:border-b-0';
                li.innerHTML = `
                    <span class="text-sm font-medium text-gray-700">${date}</span>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-900 font-bold">${averageWeight.toFixed(2)} kg</span>
                        <button class="text-red-500 hover:text-red-700 delete-btn" data-date="${date}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                historyList.appendChild(li);
            });

            // Añadir event listeners a los botones de eliminar
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const dateToDelete = e.currentTarget.dataset.date;
                    deleteWeightEntry(dateToDelete);
                });
            });
        };

        /**
         * Función principal para renderizar toda la UI.
         */
        const renderUI = () => {
            renderProgress();
            if (Object.keys(weightData).length > 0) {
                chartSection.classList.remove('hidden');
                renderChart();
            } else {
                chartSection.classList.add('hidden');
            }
            renderHistory();
        };

        // Manejadores de eventos
        
        /**
         * Maneja el guardado del peso.
         */
        const handleSaveWeight = () => {
            const weight = parseFloat(weightInput.value);
            const date = dateInput.value;

            if (!weight || !date) {
                showMessage('Por favor, ingresa un peso y una fecha válidos.', 'error');
                return;
            }

            if (!startWeight) {
                startWeight = weight;
            }

            if (weightData[date]) {
                weightData[date].push(weight);
            } else {
                weightData[date] = [weight];
            }

            saveData();
            renderUI();
            hideModal();
            showMessage('Peso guardado correctamente.', 'success');
            weightInput.value = '';
        };

        /**
         * Maneja el establecimiento de la meta de peso.
         */
        const handleSetGoal = () => {
            const newGoal = parseFloat(goalInput.value);
            if (!newGoal) {
                showMessage('Por favor, ingresa una meta de peso válida.', 'error');
                return;
            }
            goalWeight = newGoal;
            goalDisplay.textContent = `Meta: ${newGoal.toFixed(2)} kg`;
            saveData();
            renderUI();
            showMessage('Meta de peso establecida.', 'success');
        };

        /**
         * Muestra la ventana modal.
         */
        const showModal = () => {
            weightModal.classList.remove('hidden');
        };

        /**
         * Oculta la ventana modal.
         */
        const hideModal = () => {
            weightModal.classList.add('hidden');
        };

        // Event Listeners
        saveBtn.addEventListener('click', handleSaveWeight);
        setGoalBtn.addEventListener('click', handleSetGoal);
        showModalBtn.addEventListener('click', showModal);
        closeModalBtn.addEventListener('click', hideModal);
        weightModal.addEventListener('click', (e) => {
            if (e.target === weightModal) {
                hideModal();
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !weightModal.classList.contains('hidden')) {
                hideModal();
            }
        });
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderUI();
            if (goalWeight) {
                goalDisplay.textContent = `Meta: ${goalWeight.toFixed(2)} kg`;
            }
        });

    </script>
</body>
</html>
